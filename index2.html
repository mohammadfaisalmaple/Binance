<!DOCTYPE html>
<html>
<head>
    <title>MetaMask Interaction</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">MetaMask Interaction</a>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <h2>Account Balances</h2>
            <select id="accountDropdown" class="form-control mb-2"></select>
        </div>
        <div class="col-md-6">
            <h2>Send Transaction</h2>
            <input id="recipientAddress" class="form-control mb-2" placeholder="Recipient's Address">
            <input id="amountInput" class="form-control mb-2" placeholder="Amount in ETH">
            <button id="sendTransactionButton" class="btn btn-primary">Send Transaction</button>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <h2>Transaction History</h2>
            <table id="transactionHistoryTable" class="table table-striped">
                <thead>
                <tr>
                    <th>Transaction Hash</th>
                    <th>Block Number</th>
                    <th>Value (ETH)</th>
                </tr>
                </thead>
                <tbody id="transactionHistoryBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        let web3;
        let selectedAccount;

        const accountDropdown = document.querySelector('#accountDropdown');
        const recipientAddressInput = document.querySelector('#recipientAddress');
        const amountInput = document.querySelector('#amountInput');
        const sendTransactionButton = document.querySelector('#sendTransactionButton');
        const transactionHistoryBody = document.querySelector('#transactionHistoryBody');

        async function updateAccountBalances() {
            const accounts = await web3.eth.getAccounts();
            accountDropdown.innerHTML = '';
            for (const account of accounts) {
                const balance = await web3.eth.getBalance(account);
                const balanceInEth = web3.utils.fromWei(balance);
                const balanceInUsd = await getBalanceInUsd(balanceInEth);
                accountDropdown.innerHTML += `<option value="${account}" data-balance="${balanceInEth}">${account} (Balance: ${balanceInEth} ETH / ${balanceInUsd} USD)</option>`;
            }
        }

        async function getBalanceInUsd(balanceInEth) {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
                const data = await response.json();
                const ethToUsdRate = data.ethereum.usd;
                const balanceInUsd = (parseFloat(balanceInEth) * ethToUsdRate).toFixed(2);
                return balanceInUsd;
            } catch (error) {
                console.error('Error fetching ETH to USD exchange rate:', error);
                return 'N/A';
            }
        }

        async function updateTransactionHistoryAjax(account) {
            try {
                const response = await fetch(`/get-transaction-history?account=${account}`);
                const data = await response.json();

                transactionHistoryBody.innerHTML = '';

                for (const transaction of data.transactions) {
                    transactionHistoryBody.innerHTML += `
                            <tr>
                                <td>${transaction.transactionHash}</td>
                                <td>${transaction.blockNumber}</td>
                                <td>${transaction.value} ETH</td>
                            </tr>
                        `;
                }
            } catch (error) {
                console.error('Error fetching transaction history:', error);
            }
        }

        sendTransactionButton.addEventListener('click', async () => {
            if (!web3) {
                alert('Please connect to MetaMask first.');
                return;
            }

            const selectedOption = accountDropdown.options[accountDropdown.selectedIndex];
            const fromAccount = selectedOption.value;
            const toAccount = recipientAddressInput.value;
            const amountInEther = parseFloat(amountInput.value);

            if (!toAccount || isNaN(amountInEther) || amountInEther <= 0) {
                alert('Please enter valid recipient address and amount.');
                return;
            }

            try {
                const txHash = await web3.eth.sendTransaction({
                    from: fromAccount,
                    to: toAccount,
                    value: web3.utils.toWei(amountInEther.toString(), 'ether'),
                });

                Swal.fire({
                    title: 'Sending Transaction...',
                    allowOutsideClick: false,
                    onBeforeOpen: () => {
                        Swal.showLoading();
                    }
                });

                await web3.eth.waitForTransactionReceipt(txHash);

                const balanceInUsd = await getBalanceInUsd(amountInEther);

                Swal.fire('Transaction Successful!', `Transaction of ${amountInEther} ETH ($${balanceInUsd} USD) has been confirmed.`, 'success');
                updateTransactionHistoryAjax(selectedOption.value);
            } catch (error) {
                Swal.fire('Transaction Failed', 'The transaction failed or was not confirmed.', 'error');
                console.error('Transaction Error:', error);
            }
        });

        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.request({ method: 'eth_requestAccounts' }).then(() => {
                web3 = new Web3(window.ethereum);
                updateAccountBalances();
                const selectedOption = accountDropdown.options[accountDropdown.selectedIndex];
                selectedAccount = selectedOption.value;
                updateTransactionHistoryAjax(selectedAccount);
            }).catch(err => {
                alert('Error connecting to MetaMask: ' + err.message);
            });
        } else {
            alert('MetaMask is not installed. Please install it and try again.');
        }
    });
</script>
</body>
</html>
